{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Importing ARCOS Data with Dask"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Last week, we used dask to play with a few datasets to get a feel for how dask works. In order to help us develop code that would run quickly, however, we worked with very small, safe datasets. \n",
    "\n",
    "Today, we will continue to work with dask, but this time using much larger datasets. This means that (a) doing things incorrectly may lead to your computer crashing (So save all your open files before you start!), and (b) many of the commands you are being asked run will take several minutes each. \n",
    "\n",
    "For familiarity, and so you can see what advantages dask can bring to your workflow, today we'll be working with the DEA ARCOS drug shipment database published by the Washington Post! However, to strike a balance between size and speed, we'll be working with a slightly thinned version that has only the last two years of data, instead of all six."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "**(1)** Download the thinned ARCOS data [from this link](https://www.dropbox.com/s/o7nc6yvrwog4ozi/arcos_2011_2012.tsv.zip?dl=0). It should be about 2GB zipped, 25 GB unzipped. "
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "**(2)** Our goal today is going to be to find the pharmaceutical company that has shipped the most pills (`DOSAGE_UNIT`) in the US. \n",
    "\n",
    "When working with large datasets, it is good practice to begin by prototyping your code with a subset of your data. So begin by using `pandas` to read in the first 100,000 lines of the ARCOS data and write pandas code to compute the shipments from each shipper (the group that reported the shipment). "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/Users/Nick/miniconda3/lib/python3.7/site-packages/IPython/core/interactiveshell.py:3058: DtypeWarning: Columns (4,6,27) have mixed types. Specify dtype option on import or set low_memory=False.\n",
      "  interactivity=interactivity, compiler=compiler, result=result)\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>97618</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>Unnamed: 0</th>\n",
       "      <td>60845</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>REPORTER_DEA_NO</th>\n",
       "      <td>PM0018425</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>REPORTER_BUS_ACT</th>\n",
       "      <td>DISTRIBUTOR</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>REPORTER_NAME</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>REPORTER_ADDL_CO_INFO</th>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>REPORTER_ADDRESS1</th>\n",
       "      <td>DBA MCKESSON DRUG CO.</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>REPORTER_ADDRESS2</th>\n",
       "      <td>14500 E 39TH AVE</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>REPORTER_CITY</th>\n",
       "      <td>AURORA</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>REPORTER_STATE</th>\n",
       "      <td>CO</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>REPORTER_ZIP</th>\n",
       "      <td>80011</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>REPORTER_COUNTY</th>\n",
       "      <td>ADAMS</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>BUYER_DEA_NO</th>\n",
       "      <td>BS7043350</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>BUYER_BUS_ACT</th>\n",
       "      <td>CHAIN PHARMACY</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>BUYER_NAME</th>\n",
       "      <td>SAFEWAY INC</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>BUYER_ADDL_CO_INFO</th>\n",
       "      <td>SAFEWAY PHARMACY #1791</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>BUYER_ADDRESS1</th>\n",
       "      <td>1535 MAIN ST</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>BUYER_ADDRESS2</th>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>BUYER_CITY</th>\n",
       "      <td>WINDSOR</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>BUYER_STATE</th>\n",
       "      <td>CO</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>BUYER_ZIP</th>\n",
       "      <td>80550</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>BUYER_COUNTY</th>\n",
       "      <td>WELD</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>TRANSACTION_CODE</th>\n",
       "      <td>S</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>DRUG_CODE</th>\n",
       "      <td>9143</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>NDC_NO</th>\n",
       "      <td>10702005601</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>DRUG_NAME</th>\n",
       "      <td>OXYCODONE</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>QUANTITY</th>\n",
       "      <td>2</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>UNIT</th>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ACTION_INDICATOR</th>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ORDER_FORM_NO</th>\n",
       "      <td>116609681</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>CORRECTION_NO</th>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>STRENGTH</th>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>TRANSACTION_DATE</th>\n",
       "      <td>2152012</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>CALC_BASE_WT_IN_GM</th>\n",
       "      <td>1.793</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>DOSAGE_UNIT</th>\n",
       "      <td>200</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>TRANSACTION_ID</th>\n",
       "      <td>1202021235</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Product_Name</th>\n",
       "      <td>OXYCODONE HCI 10MG TABLETS USP</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Ingredient_Name</th>\n",
       "      <td>OXYCODONE HYDROCHLORIDE</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Measure</th>\n",
       "      <td>TAB</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>MME_Conversion_Factor</th>\n",
       "      <td>1.5</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Combined_Labeler_Name</th>\n",
       "      <td>KVK-Tech, Inc.</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Revised_Company_Name</th>\n",
       "      <td>KVK-Tech, Inc.</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Reporter_family</th>\n",
       "      <td>McKesson Corporation</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>dos_str</th>\n",
       "      <td>10</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>date</th>\n",
       "      <td>2012-02-15</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>year</th>\n",
       "      <td>2012</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                                                97618\n",
       "Unnamed: 0                                      60845\n",
       "REPORTER_DEA_NO                             PM0018425\n",
       "REPORTER_BUS_ACT                          DISTRIBUTOR\n",
       "REPORTER_NAME                    MCKESSON CORPORATION\n",
       "REPORTER_ADDL_CO_INFO                             NaN\n",
       "REPORTER_ADDRESS1               DBA MCKESSON DRUG CO.\n",
       "REPORTER_ADDRESS2                    14500 E 39TH AVE\n",
       "REPORTER_CITY                                  AURORA\n",
       "REPORTER_STATE                                     CO\n",
       "REPORTER_ZIP                                    80011\n",
       "REPORTER_COUNTY                                 ADAMS\n",
       "BUYER_DEA_NO                                BS7043350\n",
       "BUYER_BUS_ACT                          CHAIN PHARMACY\n",
       "BUYER_NAME                                SAFEWAY INC\n",
       "BUYER_ADDL_CO_INFO             SAFEWAY PHARMACY #1791\n",
       "BUYER_ADDRESS1                           1535 MAIN ST\n",
       "BUYER_ADDRESS2                                    NaN\n",
       "BUYER_CITY                                    WINDSOR\n",
       "BUYER_STATE                                        CO\n",
       "BUYER_ZIP                                       80550\n",
       "BUYER_COUNTY                                     WELD\n",
       "TRANSACTION_CODE                                    S\n",
       "DRUG_CODE                                        9143\n",
       "NDC_NO                                    10702005601\n",
       "DRUG_NAME                                   OXYCODONE\n",
       "QUANTITY                                            2\n",
       "UNIT                                              NaN\n",
       "ACTION_INDICATOR                                  NaN\n",
       "ORDER_FORM_NO                               116609681\n",
       "CORRECTION_NO                                     NaN\n",
       "STRENGTH                                          NaN\n",
       "TRANSACTION_DATE                              2152012\n",
       "CALC_BASE_WT_IN_GM                              1.793\n",
       "DOSAGE_UNIT                                       200\n",
       "TRANSACTION_ID                             1202021235\n",
       "Product_Name           OXYCODONE HCI 10MG TABLETS USP\n",
       "Ingredient_Name               OXYCODONE HYDROCHLORIDE\n",
       "Measure                                           TAB\n",
       "MME_Conversion_Factor                             1.5\n",
       "Combined_Labeler_Name                  KVK-Tech, Inc.\n",
       "Revised_Company_Name                   KVK-Tech, Inc.\n",
       "Reporter_family                  McKesson Corporation\n",
       "dos_str                                            10\n",
       "date                                       2012-02-15\n",
       "year                                             2012"
      ]
     },
     "execution_count": 1,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import os\n",
    "os.chdir(\"/users/nick/downloads/\")\n",
    "\n",
    "df = pd.read_csv('arcos_2011_2012.tsv', nrows=100000, sep='\\t')\n",
    "df.sample().T"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>REPORTER_NAME</th>\n",
       "      <th>DOSAGE_UNIT</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>20</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>21616840.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>AMERISOURCEBERGEN DRUG CORP</td>\n",
       "      <td>4154600.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>CARDINAL HEALTH 110, LLC</td>\n",
       "      <td>4013680.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>17</th>\n",
       "      <td>KINRAY INC</td>\n",
       "      <td>1713820.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>19</th>\n",
       "      <td>LOUISIANA WHOLESALE DRUG CO</td>\n",
       "      <td>1270180.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>KAISER FOUNDATION HOSPITALS</td>\n",
       "      <td>1185850.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>FRANK W KERR INC</td>\n",
       "      <td>887120.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>AMERICAN SALES COMPANY</td>\n",
       "      <td>840070.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>H D SMITH WHOLESALE DRUG CO</td>\n",
       "      <td>690380.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>DIK DRUG CO</td>\n",
       "      <td>492860.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>18</th>\n",
       "      <td>KPH HEALTHCARE SERVICES, INC.</td>\n",
       "      <td>429900.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>15</th>\n",
       "      <td>KAISER FNDTN HEALTH PLAN NW</td>\n",
       "      <td>377320.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>BLOODWORTH WHOLESALE DRUGS</td>\n",
       "      <td>349750.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>DISCOUNT DRUG MART</td>\n",
       "      <td>347910.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>BURLINGTON DRUG COMPANY</td>\n",
       "      <td>302880.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>13</th>\n",
       "      <td>H J HARKINS COMPANY INC</td>\n",
       "      <td>75968.6</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>CAPITAL WHOLESALE DRUG &amp; CO</td>\n",
       "      <td>26800.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>APOTHECA INC</td>\n",
       "      <td>6250.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>14</th>\n",
       "      <td>HALS MED DENT SUPPLY CO., INC.</td>\n",
       "      <td>3000.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>CESAR CASTILLO INC</td>\n",
       "      <td>700.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>21</th>\n",
       "      <td>MERRITT VETERINARY SUPPLIES INC</td>\n",
       "      <td>600.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>ACE SURGICAL SUPPLY CO INC</td>\n",
       "      <td>100.0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                      REPORTER_NAME  DOSAGE_UNIT\n",
       "20             MCKESSON CORPORATION   21616840.0\n",
       "2       AMERISOURCEBERGEN DRUG CORP    4154600.0\n",
       "7          CARDINAL HEALTH 110, LLC    4013680.0\n",
       "17                       KINRAY INC    1713820.0\n",
       "19      LOUISIANA WHOLESALE DRUG CO    1270180.0\n",
       "16      KAISER FOUNDATION HOSPITALS    1185850.0\n",
       "11                 FRANK W KERR INC     887120.0\n",
       "1            AMERICAN SALES COMPANY     840070.0\n",
       "12      H D SMITH WHOLESALE DRUG CO     690380.0\n",
       "9                       DIK DRUG CO     492860.0\n",
       "18    KPH HEALTHCARE SERVICES, INC.     429900.0\n",
       "15      KAISER FNDTN HEALTH PLAN NW     377320.0\n",
       "4        BLOODWORTH WHOLESALE DRUGS     349750.0\n",
       "10               DISCOUNT DRUG MART     347910.0\n",
       "5           BURLINGTON DRUG COMPANY     302880.0\n",
       "13          H J HARKINS COMPANY INC      75968.6\n",
       "6       CAPITAL WHOLESALE DRUG & CO      26800.0\n",
       "3                      APOTHECA INC       6250.0\n",
       "14   HALS MED DENT SUPPLY CO., INC.       3000.0\n",
       "8                CESAR CASTILLO INC        700.0\n",
       "21  MERRITT VETERINARY SUPPLIES INC        600.0\n",
       "0        ACE SURGICAL SUPPLY CO INC        100.0"
      ]
     },
     "execution_count": 2,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "grouped = df.groupby(['REPORTER_NAME'], as_index=False)['DOSAGE_UNIT'].sum()\n",
    "grouped.sort_values('DOSAGE_UNIT', ascending=False)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "**(3)** Now let's turn to dask. Re-write your code for dask, and calculate the total shipments by reporting company. Remember: \n",
    "\n",
    "- Start by spinning up a cluster\n",
    "- Dask won't read compressed files, so you have to unzip your ARCOS data. \n",
    "- Start your cluster in a cell all by itself since you don't want to keep re-running the \"start a cluster\" code. \n",
    "\n",
    "If you need to review dask basic code, [check here](../distributed_computing.ipynb).\n",
    "\n",
    "As you run your code, make sure to click on the Dashboard link below where you created your cluster:\n",
    "\n",
    "![dask_dashboard](../images/dask_dashboard.png)\n",
    "\n",
    "Among other things, the bar across the bottom should give you a sense of how long your task will take:\n",
    "\n",
    "![dask_progress](../images/dask_progress.png)\n",
    "\n",
    "(For context, my core (which has 8 physical cores that present as 16 with hyperthreading) took about 30 seconds. My computer is fast, but most computers should be done within a couple minutes). "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table style=\"border: 2px solid white;\">\n",
       "<tr>\n",
       "<td style=\"vertical-align: top; border: 0px solid white\">\n",
       "<h3 style=\"text-align: left;\">Client</h3>\n",
       "<ul style=\"text-align: left; list-style: none; margin: 0; padding: 0;\">\n",
       "  <li><b>Scheduler: </b>tcp://127.0.0.1:53975</li>\n",
       "  <li><b>Dashboard: </b><a href='http://127.0.0.1:8787/status' target='_blank'>http://127.0.0.1:8787/status</a>\n",
       "</ul>\n",
       "</td>\n",
       "<td style=\"vertical-align: top; border: 0px solid white\">\n",
       "<h3 style=\"text-align: left;\">Cluster</h3>\n",
       "<ul style=\"text-align: left; list-style:none; margin: 0; padding: 0;\">\n",
       "  <li><b>Workers: </b>4</li>\n",
       "  <li><b>Cores: </b>16</li>\n",
       "  <li><b>Memory: </b>34.36 GB</li>\n",
       "</ul>\n",
       "</td>\n",
       "</tr>\n",
       "</table>"
      ],
      "text/plain": [
       "<Client: 'tcp://127.0.0.1:53975' processes=4 threads=16, memory=34.36 GB>"
      ]
     },
     "execution_count": 3,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "from dask.distributed import Client\n",
    "client = Client(n_workers=4)\n",
    "client"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [],
   "source": [
    "import dask.dataframe as dd\n",
    "df = dd.read_csv('/users/nick/downloads/arcos_2011_2012.tsv', \n",
    "            sep='\\t', \n",
    "            usecols=['REPORTER_NAME', 'DOSAGE_UNIT'])\n",
    "grouped = df.groupby(['REPORTER_NAME'])['DOSAGE_UNIT'].sum()\n",
    "results = grouped.compute()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "REPORTER_NAME\n",
       "MCKESSON CORPORATION                             4.708292e+06\n",
       "WALGREEN CO                                      3.973797e+06\n",
       "CARDINAL HEALTH                                  3.451575e+06\n",
       "AMERISOURCEBERGEN DRUG CORP                      2.256760e+06\n",
       "CVS INDIANA                                      5.982532e+05\n",
       "                                                     ...     \n",
       "SOUTHERN MEDICAL LASERS DBA SML MEDICAL SALES    1.000000e-01\n",
       "CEPHALON, INC.                                   8.000000e-02\n",
       "MIKART                                           5.600000e-02\n",
       "REMEDYREPACK                                     4.000000e-02\n",
       "ARK BUSINESS SERVICES INC                        4.000000e-02\n",
       "Name: DOSAGE_UNIT, Length: 316, dtype: float64"
      ]
     },
     "execution_count": 7,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "results.sort_values(ascending=False) / 1000"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "**(4)** Now let's calculate, *for each state*, what company shipped the most pills?\n",
    "\n",
    "Note you will quickly find that you can't sort in dask -- sorting in parallel is *really* tricky! So you'll have to work around that. Do what you need to do on the big dataset first, then compute it all so you get it as a regular pandas dataframe, then finish. "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {},
   "outputs": [],
   "source": [
    "import dask.dataframe as dd\n",
    "df = dd.read_csv('/users/nick/downloads/arcos_2011_2012.tsv', \n",
    "            sep='\\t', \n",
    "            usecols=['REPORTER_NAME', 'DOSAGE_UNIT', 'BUYER_STATE'])\n",
    "grouped = df.groupby(['REPORTER_NAME', 'BUYER_STATE'])['DOSAGE_UNIT'].sum().reset_index()\n",
    "results = grouped.compute()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>REPORTER_NAME</th>\n",
       "      <th>DOSAGE_UNIT</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>BUYER_STATE</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>AK</th>\n",
       "      <td>CARDINAL HEALTH</td>\n",
       "      <td>12912712.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>AL</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>210395190.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>AR</th>\n",
       "      <td>AMERISOURCEBERGEN DRUG CORPORATION</td>\n",
       "      <td>57196800.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>AZ</th>\n",
       "      <td>WALGREEN CO</td>\n",
       "      <td>176419710.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>CA</th>\n",
       "      <td>AMERISOURCEBERGEN DRUG CORP</td>\n",
       "      <td>449992280.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>CO</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>74987840.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>CT</th>\n",
       "      <td>CARDINAL HEALTH</td>\n",
       "      <td>56635720.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>DC</th>\n",
       "      <td>CARDINAL HEALTH</td>\n",
       "      <td>9694400.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>DE</th>\n",
       "      <td>WALGREEN CO</td>\n",
       "      <td>29274900.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>FL</th>\n",
       "      <td>WALGREEN CO</td>\n",
       "      <td>459455250.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>GA</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>127935540.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>GU</th>\n",
       "      <td>AMERISOURCEBERGEN DRUG CORP</td>\n",
       "      <td>964500.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>HI</th>\n",
       "      <td>AMERISOURCEBERGEN DRUG CORP</td>\n",
       "      <td>27102040.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>IA</th>\n",
       "      <td>WALGREEN CO</td>\n",
       "      <td>40055380.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ID</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>34168720.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>IL</th>\n",
       "      <td>WALGREEN CO</td>\n",
       "      <td>265412740.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>IN</th>\n",
       "      <td>CVS INDIANA</td>\n",
       "      <td>193518900.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>KS</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>76247270.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>KY</th>\n",
       "      <td>AMERISOURCEBERGEN DRUG CORP</td>\n",
       "      <td>149117060.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>LA</th>\n",
       "      <td>WALGREEN CO</td>\n",
       "      <td>91262050.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>MA</th>\n",
       "      <td>CARDINAL HEALTH</td>\n",
       "      <td>132415210.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>MD</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>142428820.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ME</th>\n",
       "      <td>CARDINAL HEALTH</td>\n",
       "      <td>44604490.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>MI</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>196841400.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>MN</th>\n",
       "      <td>MCKESSON DRUG COMPANY</td>\n",
       "      <td>77370860.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>MO</th>\n",
       "      <td>WALGREEN CO</td>\n",
       "      <td>128879010.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>MP</th>\n",
       "      <td>AMERISOURCEBERGEN DRUG CORP</td>\n",
       "      <td>287900.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>MS</th>\n",
       "      <td>AMERISOURCEBERGEN DRUG CORP</td>\n",
       "      <td>65602720.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>MT</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>34330100.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>NC</th>\n",
       "      <td>CARDINAL HEALTH</td>\n",
       "      <td>186727600.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ND</th>\n",
       "      <td>MCKESSON DRUG COMPANY</td>\n",
       "      <td>10297650.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>NE</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>31205240.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>NH</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>21763450.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>NJ</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>98708550.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>NM</th>\n",
       "      <td>WALGREEN ARIZONA DRUG CO</td>\n",
       "      <td>31751330.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>NV</th>\n",
       "      <td>WALGREEN CO</td>\n",
       "      <td>96501610.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>NY</th>\n",
       "      <td>CARDINAL HEALTH 110, LLC</td>\n",
       "      <td>259680450.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>OH</th>\n",
       "      <td>CARDINAL HEALTH</td>\n",
       "      <td>238501750.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>OK</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>121119950.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>OR</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>129109660.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>PA</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>250514560.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>PR</th>\n",
       "      <td>DROGUERIA BETANCES, LLC</td>\n",
       "      <td>11419040.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>RI</th>\n",
       "      <td>CARDINAL HEALTH</td>\n",
       "      <td>19344120.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>SC</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>237201700.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>SD</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>13952560.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>TN</th>\n",
       "      <td>WALGREEN CO</td>\n",
       "      <td>131097140.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>TX</th>\n",
       "      <td>WALGREEN CO</td>\n",
       "      <td>376538690.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>UT</th>\n",
       "      <td>AMERISOURCEBERGEN DRUG CORP</td>\n",
       "      <td>58896360.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>VA</th>\n",
       "      <td>CARDINAL HEALTH</td>\n",
       "      <td>113905462.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>VI</th>\n",
       "      <td>CARDINAL HEALTH P.R. 120, INC.</td>\n",
       "      <td>622220.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>VT</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>12777210.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>WA</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>169188860.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>WI</th>\n",
       "      <td>WALGREEN CO</td>\n",
       "      <td>171923190.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>WV</th>\n",
       "      <td>CARDINAL HEALTH</td>\n",
       "      <td>70562930.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>WY</th>\n",
       "      <td>MCKESSON CORPORATION</td>\n",
       "      <td>10089750.0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                                  REPORTER_NAME  DOSAGE_UNIT\n",
       "BUYER_STATE                                                 \n",
       "AK                              CARDINAL HEALTH   12912712.0\n",
       "AL                         MCKESSON CORPORATION  210395190.0\n",
       "AR           AMERISOURCEBERGEN DRUG CORPORATION   57196800.0\n",
       "AZ                                  WALGREEN CO  176419710.0\n",
       "CA                  AMERISOURCEBERGEN DRUG CORP  449992280.0\n",
       "CO                         MCKESSON CORPORATION   74987840.0\n",
       "CT                              CARDINAL HEALTH   56635720.0\n",
       "DC                              CARDINAL HEALTH    9694400.0\n",
       "DE                                  WALGREEN CO   29274900.0\n",
       "FL                                  WALGREEN CO  459455250.0\n",
       "GA                         MCKESSON CORPORATION  127935540.0\n",
       "GU                  AMERISOURCEBERGEN DRUG CORP     964500.0\n",
       "HI                  AMERISOURCEBERGEN DRUG CORP   27102040.0\n",
       "IA                                  WALGREEN CO   40055380.0\n",
       "ID                         MCKESSON CORPORATION   34168720.0\n",
       "IL                                  WALGREEN CO  265412740.0\n",
       "IN                                  CVS INDIANA  193518900.0\n",
       "KS                         MCKESSON CORPORATION   76247270.0\n",
       "KY                  AMERISOURCEBERGEN DRUG CORP  149117060.0\n",
       "LA                                  WALGREEN CO   91262050.0\n",
       "MA                              CARDINAL HEALTH  132415210.0\n",
       "MD                         MCKESSON CORPORATION  142428820.0\n",
       "ME                              CARDINAL HEALTH   44604490.0\n",
       "MI                         MCKESSON CORPORATION  196841400.0\n",
       "MN                        MCKESSON DRUG COMPANY   77370860.0\n",
       "MO                                  WALGREEN CO  128879010.0\n",
       "MP                  AMERISOURCEBERGEN DRUG CORP     287900.0\n",
       "MS                  AMERISOURCEBERGEN DRUG CORP   65602720.0\n",
       "MT                         MCKESSON CORPORATION   34330100.0\n",
       "NC                              CARDINAL HEALTH  186727600.0\n",
       "ND                        MCKESSON DRUG COMPANY   10297650.0\n",
       "NE                         MCKESSON CORPORATION   31205240.0\n",
       "NH                         MCKESSON CORPORATION   21763450.0\n",
       "NJ                         MCKESSON CORPORATION   98708550.0\n",
       "NM                     WALGREEN ARIZONA DRUG CO   31751330.0\n",
       "NV                                  WALGREEN CO   96501610.0\n",
       "NY                     CARDINAL HEALTH 110, LLC  259680450.0\n",
       "OH                              CARDINAL HEALTH  238501750.0\n",
       "OK                         MCKESSON CORPORATION  121119950.0\n",
       "OR                         MCKESSON CORPORATION  129109660.0\n",
       "PA                         MCKESSON CORPORATION  250514560.0\n",
       "PR                      DROGUERIA BETANCES, LLC   11419040.0\n",
       "RI                              CARDINAL HEALTH   19344120.0\n",
       "SC                         MCKESSON CORPORATION  237201700.0\n",
       "SD                         MCKESSON CORPORATION   13952560.0\n",
       "TN                                  WALGREEN CO  131097140.0\n",
       "TX                                  WALGREEN CO  376538690.0\n",
       "UT                  AMERISOURCEBERGEN DRUG CORP   58896360.0\n",
       "VA                              CARDINAL HEALTH  113905462.0\n",
       "VI               CARDINAL HEALTH P.R. 120, INC.     622220.0\n",
       "VT                         MCKESSON CORPORATION   12777210.0\n",
       "WA                         MCKESSON CORPORATION  169188860.0\n",
       "WI                                  WALGREEN CO  171923190.0\n",
       "WV                              CARDINAL HEALTH   70562930.0\n",
       "WY                         MCKESSON CORPORATION   10089750.0"
      ]
     },
     "execution_count": 9,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "results = results.sort_values(['DOSAGE_UNIT'], ascending=False)\n",
    "state_maxes = results.groupby(['BUYER_STATE']).nth(0)\n",
    "state_maxes"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Does this seem like a situation where a single company is responsible for the opioid epidemic?"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "**(5)** Now go ahead and try and re-do the chunking you did by hand for your project -- calculate, for each year, the total morphine equivalents sent to each county in the US. "
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.7.3"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
